<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор карт Таро</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 16px;
            color: var(--tg-theme-text-color, #000);
            background-color: var(--tg-theme-bg-color, #fff);
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color, #000);
        }
        .instructions {
            text-align: center;
            margin-bottom: 20px;
            color: var(--tg-theme-hint-color, #999);
        }
        .card-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .card {
            position: relative;
            aspect-ratio: 2/3;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s ease, background-image 0.5s ease;
            /* Рубашка карты по умолчанию */
            background-image: url('https://www.deckofcardsapi.com/static/img/back.png');
        }
        .card.selected {
            transform: translateY(-10px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .card.selected::after {
            content: "✓";
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #fff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .selected-count {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .button {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            margin-top: 20px;
        }
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #log {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: block !important; /* Всегда отображать лог */
        }
        .log-title {
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 5px;
            color: red;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }
        .error {
            margin-top: 20px;
            padding: 15px;
            background-color: #ffebee;
            border: 1px solid #f44336;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }
        .manual-close {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Выбор карт Таро</h1>
    <p class="instructions">Выберите 3 карты, которые вас привлекают</p>
    <div class="selected-count">Выбрано: <span id="count">0</span>/3</div>
    
    <div class="card-container" id="cards"></div>
    
    <button class="button" id="submit-button" disabled>Получить толкование</button>
    
    <!-- Результат отправки данных -->
    <div class="result" id="result">Данные успешно отправлены!</div>
    <div class="error" id="error">Ошибка при отправке данных</div>
    <button class="manual-close" id="manual-close">Закрыть приложение</button>
    
    <!-- Лог для отладки -->
    <div class="log-title">Лог отладки (важно!):</div>
    <div id="log">Инициализация...</div>

    <script>
        // Функция для логирования
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 8);
            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Инициализация Telegram WebApp
        const tgApp = window.Telegram.WebApp;
        log("Инициализация Telegram WebApp");
        
        // Проверяем, что tgApp существует
        if (!tgApp) {
            log("ОШИБКА: tgApp не определен");
        } else {
            log("tgApp определен успешно");
            log(`Версия Telegram WebApp: ${tgApp.version || 'не определена'}`);
            log(`Платформа: ${tgApp.platform || 'не определена'}`);
        }
        
        tgApp.expand();
        log("tgApp.expand() вызван");
        
        tgApp.ready();
        log("tgApp.ready() вызван");
        
        // Получаем initData
        const initData = tgApp.initData || '';
        log(`initData: ${initData.substring(0, 50)}...`);
        
        // Парсим initData
        const initDataParams = new URLSearchParams(initData);
        const user = initDataParams.get('user') ? JSON.parse(decodeURIComponent(initDataParams.get('user'))) : null;
        const chat = initDataParams.get('chat') ? JSON.parse(decodeURIComponent(initDataParams.get('chat'))) : null;
        const queryId = initDataParams.get('query_id');
        
        log(`User: ${user ? JSON.stringify(user).substring(0, 50) : 'не определен'}...`);
        log(`Chat: ${chat ? JSON.stringify(chat).substring(0, 50) : 'не определен'}...`);
        log(`Query ID: ${queryId || 'не определен'}`);
        
        // Включаем кнопку "Готово" в верхней части приложения
        tgApp.MainButton.setText('Готово');
        log("tgApp.MainButton.setText('Готово') вызван");
        
        tgApp.MainButton.hide();
        log("tgApp.MainButton.hide() вызван");

        // Карты Таро (используем те же URL, что и в боте)
        const tarotCards = [
            { id: 0, name: "Шут", image: "https://upload.wikimedia.org/wikipedia/commons/9/90/RWS_Tarot_00_Fool.jpg" },
            { id: 1, name: "Маг", image: "https://upload.wikimedia.org/wikipedia/commons/d/de/RWS_Tarot_01_Magician.jpg" },
            { id: 2, name: "Верховная Жрица", image: "https://upload.wikimedia.org/wikipedia/commons/8/88/RWS_Tarot_02_High_Priestess.jpg" },
            { id: 3, name: "Императрица", image: "https://upload.wikimedia.org/wikipedia/commons/d/d2/RWS_Tarot_03_Empress.jpg" },
            { id: 4, name: "Император", image: "https://upload.wikimedia.org/wikipedia/commons/c/c3/RWS_Tarot_04_Emperor.jpg" },
            { id: 5, name: "Иерофант", image: "https://upload.wikimedia.org/wikipedia/commons/8/8d/RWS_Tarot_05_Hierophant.jpg" },
            { id: 6, name: "Влюбленные", image: "https://upload.wikimedia.org/wikipedia/commons/3/3a/TheLovers.jpg" },
            { id: 7, name: "Колесница", image: "https://upload.wikimedia.org/wikipedia/commons/9/9b/RWS_Tarot_07_Chariot.jpg" },
            { id: 8, name: "Сила", image: "https://upload.wikimedia.org/wikipedia/commons/f/f5/RWS_Tarot_08_Strength.jpg" },
            { id: 9, name: "Отшельник", image: "https://upload.wikimedia.org/wikipedia/commons/4/4d/RWS_Tarot_09_Hermit.jpg" },
            { id: 10, name: "Колесо Фортуны", image: "https://upload.wikimedia.org/wikipedia/commons/3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg" },
            { id: 11, name: "Справедливость", image: "https://upload.wikimedia.org/wikipedia/commons/e/e0/RWS_Tarot_11_Justice.jpg" },
            { id: 12, name: "Повешенный", image: "https://upload.wikimedia.org/wikipedia/commons/2/2b/RWS_Tarot_12_Hanged_Man.jpg" },
            { id: 13, name: "Смерть", image: "https://upload.wikimedia.org/wikipedia/commons/d/d7/RWS_Tarot_13_Death.jpg" },
            { id: 14, name: "Умеренность", image: "https://upload.wikimedia.org/wikipedia/commons/f/f8/RWS_Tarot_14_Temperance.jpg" },
            { id: 15, name: "Дьявол", image: "https://upload.wikimedia.org/wikipedia/commons/5/55/RWS_Tarot_15_Devil.jpg" },
            { id: 16, name: "Башня", image: "https://upload.wikimedia.org/wikipedia/commons/5/53/RWS_Tarot_16_Tower.jpg" },
            { id: 17, name: "Звезда", image: "https://upload.wikimedia.org/wikipedia/commons/d/db/RWS_Tarot_17_Star.jpg" },
            { id: 18, name: "Луна", image: "https://upload.wikimedia.org/wikipedia/commons/7/7f/RWS_Tarot_18_Moon.jpg" },
            { id: 19, name: "Солнце", image: "https://upload.wikimedia.org/wikipedia/commons/1/17/RWS_Tarot_19_Sun.jpg" },
            { id: 20, name: "Суд", image: "https://upload.wikimedia.org/wikipedia/commons/d/dd/RWS_Tarot_20_Judgement.jpg" },
            { id: 21, name: "Мир", image: "https://upload.wikimedia.org/wikipedia/commons/f/ff/RWS_Tarot_21_World.jpg" }
        ];
        log("Карты Таро инициализированы");

        // Выбранные карты
        const selectedCards = [];
        const maxCards = 3;
        log("Максимальное количество карт: " + maxCards);

        // Создание карт
        const cardsContainer = document.getElementById('cards');
        const countElement = document.getElementById('count');
        const submitButton = document.getElementById('submit-button');
        const resultElement = document.getElementById('result');
        const errorElement = document.getElementById('error');
        const manualCloseButton = document.getElementById('manual-close');
        log("Элементы DOM получены");

        // Перемешиваем карты
        const shuffledCards = [...tarotCards].sort(() => Math.random() - 0.5);
        log("Карты перемешаны");

        // Отображаем первые 12 карт
        shuffledCards.slice(0, 12).forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            // Изначально показываем рубашку карты
            // Реальное изображение карты сохраняем в data-атрибуте
            cardElement.dataset.image = card.image;
            cardElement.dataset.id = card.id;
            cardElement.dataset.name = card.name;
            
            cardElement.addEventListener('click', () => {
                if (cardElement.classList.contains('selected')) {
                    // Отменяем выбор карты
                    cardElement.classList.remove('selected');
                    // Возвращаем рубашку карты
                    cardElement.style.backgroundImage = `url('https://www.deckofcardsapi.com/static/img/back.png')`;
                    const index = selectedCards.findIndex(c => c.id === parseInt(card.id));
                    if (index !== -1) {
                        selectedCards.splice(index, 1);
                    }
                    log(`Отменен выбор карты: ${card.name}`);
                } else if (selectedCards.length < maxCards) {
                    // Выбираем карту и показываем её лицевую сторону
                    cardElement.classList.add('selected');
                    cardElement.style.backgroundImage = `url(${cardElement.dataset.image})`;
                    selectedCards.push({
                        id: parseInt(card.id),
                        name: card.name
                    });
                    log(`Выбрана карта: ${card.name}`);
                }
                
                // Обновляем счетчик и состояние кнопок
                countElement.textContent = selectedCards.length;
                submitButton.disabled = selectedCards.length !== maxCards;
                log(`Выбрано карт: ${selectedCards.length}/${maxCards}`);
                
                // Показываем или скрываем кнопку "Готово" в верхней части приложения
                if (selectedCards.length === maxCards) {
                    tgApp.MainButton.show();
                    log("Кнопка MainButton показана");
                } else {
                    tgApp.MainButton.hide();
                    log("Кнопка MainButton скрыта");
                }
            });
            
            cardsContainer.appendChild(cardElement);
        });
        log("12 карт добавлены в контейнер");

        // Функция для отправки данных в бота через API
        async function sendDataToBotViaAPI() {
            log("Вызвана функция sendDataToBotViaAPI()");
            
            if (selectedCards.length === maxCards) {
                const selectedCardNames = selectedCards.map(card => card.name);
                log(`Выбранные карты: ${selectedCardNames.join(', ')}`);
                
                // Создаем JSON для отправки
                const jsonData = JSON.stringify({
                    cards: selectedCardNames
                });
                log(`Подготовленные данные: ${jsonData}`);
                
                try {
                    // Получаем chat_id из initData
                    const chatId = chat ? chat.id : (user ? user.id : null);
                    if (!chatId) {
                        throw new Error("Не удалось получить chat_id");
                    }
                    
                    log(`Chat ID: ${chatId}`);
                    
                    // Отправляем данные через API
                    const botToken = '7230803454:AAHFp5PQq8NkBQNhz3UEjAegEXdByPin-M0'; // Токен бота
                    const apiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;
                    
                    log(`Отправляем запрос на ${apiUrl}`);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: `Выбранные карты: ${selectedCardNames.join(', ')}`,
                            parse_mode: 'HTML'
                        })
                    });
                    
                    log(`Получен ответ от API: ${response.status} ${response.statusText}`);
                    
                    const result = await response.json();
                    log(`Ответ API: ${JSON.stringify(result)}`);
                    
                    if (result.ok) {
                        log("Данные успешно отправлены через API");
                        
                        // Показываем сообщение об успехе
                        resultElement.textContent = `Данные успешно отправлены через API! Выбранные карты: ${selectedCardNames.join(', ')}`;
                        resultElement.style.display = 'block';
                        manualCloseButton.style.display = 'block';
                        
                        return true;
                    } else {
                        throw new Error(`Ошибка API: ${result.description}`);
                    }
                } catch (error) {
                    log(`ОШИБКА при отправке данных через API: ${error.message}`);
                    errorElement.textContent = `Ошибка при отправке данных через API: ${error.message}`;
                    errorElement.style.display = 'block';
                    manualCloseButton.style.display = 'block';
                    return false;
                }
            } else {
                log(`ОШИБКА: Выбрано недостаточно карт (${selectedCards.length}/${maxCards})`);
                return false;
            }
        }

        // Функция для отправки данных в бота через sendData
        async function sendDataToBot() {
            log("Вызвана функция sendDataToBot()");
            
            if (selectedCards.length === maxCards) {
                const selectedCardNames = selectedCards.map(card => card.name);
                log(`Выбранные карты: ${selectedCardNames.join(', ')}`);
                
                // Создаем JSON для отправки
                const jsonData = JSON.stringify({
                    cards: selectedCardNames
                });
                log(`Подготовленные данные: ${jsonData}`);
                
                try {
                    // Отправляем данные обратно в бота
                    log("Попытка отправить данные через tgApp.sendData()");
                    tgApp.sendData(jsonData);
                    log("tgApp.sendData() выполнен успешно");
                    
                    // Показываем сообщение об успехе
                    resultElement.textContent = `Данные успешно отправлены через sendData! Выбранные карты: ${selectedCardNames.join(', ')}`;
                    resultElement.style.display = 'block';
                    manualCloseButton.style.display = 'block';
                    
                    return true;
                } catch (error) {
                    log(`ОШИБКА при отправке данных через sendData: ${error.message}`);
                    
                    // Если не удалось отправить данные через sendData, пробуем через API
                    log("Пробуем отправить данные через API");
                    return await sendDataToBotViaAPI();
                }
            } else {
                log(`ОШИБКА: Выбрано недостаточно карт (${selectedCards.length}/${maxCards})`);
                return false;
            }
        }

        // Обработка отправки выбранных карт через кнопку в приложении
        submitButton.addEventListener('click', async () => {
            log("Нажата кнопка 'Получить толкование'");
            await sendDataToBot();
        });
        
        // Обработка отправки выбранных карт через кнопку "Готово" в верхней части приложения
        tgApp.MainButton.onClick(async () => {
            log("Нажата кнопка MainButton");
            await sendDataToBot();
        });
        
        // Обработка закрытия приложения вручную
        manualCloseButton.addEventListener('click', () => {
            log("Нажата кнопка 'Закрыть приложение'");
            tgApp.close();
        });
        
        // Добавляем обработчики событий для отладки
        window.addEventListener('error', (event) => {
            log(`ОШИБКА: ${event.message} в ${event.filename}:${event.lineno}`);
        });
    </script>
</body>
</html>
